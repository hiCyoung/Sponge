{
  "title": "Untitled Note",
  "cells": [
    {
      "type": "markdown",
      "data": "## 缴费交易\n@(本木医疗)[接口, 自助缴费, 交易接口]\n\n### 更新日志\n**2017年5月22日**\n* 缴费打印信息接口，fee_item节点添加medicare_place（取药地点）字段。\n* \n\n### 业务说明\n当患者在自助机器、微信、多渠道终端，查看缴费列表后，选择某项缴费项后，平台将生成一个`订单`作为缴费的载体进行缴费后续的流程控制。后续正向的调用流程如下：\n> - 缴费锁定\n> - 医保分解信息查询\n> - 缴费完成通知\n> - 查询缴费清单打印信息\n\n### 缴费锁定\n检验及锁定缴费信息，并生成his预支付id。\n\n> **TIPS**: His应该具备逻辑包括不限于：\n> - 校验锁定的处方号不可再编辑、不可撤销，处方号是否已缴费，处方总金额校验，子项是否完整，子项组合是否符合His业务要求。\n> - 本方法调用时如果要锁定的处方下已存在预支付id且未缴费，则删除旧的预支付id，以本次调用生成新的预支付id。\n> - 医院窗口具备解除锁定后继续缴费的功能。\n\n**特别注意**平台将尽可能不重复调用该接口，以避免给His造成大量的异常数据，但是不能保证每一个缴费单只调用一次。\n\n#### 调用方式\n```powershell\nURI: /ws/in_treatment/bill/lock\nMethod: POST\n```\n\n#### 请求参数\n```xml\n<request>\n  <time_stamp>20161103163010</time_stamp>\n  <input>\n    <hos_code>H110321</hos_code>\n    <machine_code>00042_H110321</machine_code>\n    <order_id>200126324850</order_id>\n    <card_no>115520388003</card_no>\n    <card_type>3</card_type>\n    <treatment_no>777770003320161103162103</treatment_no>\n    <recipe_no>d0000035526875,d0000035526874</recipe_no>  \n    <fee>206.52</fee>\n    <sign>MEQCI==</sign>\n    <cert>1a100000000000192f53</cert>\n  </input>\n</request>\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| hos_code    | 医院编码 | 20 | 是  |  |\n| machine_code    | 机器编码 | 20 | 否  | |\n| order_id | 平台订单号| 50| 是| |\n| card_no    | 卡号 | 20 | 是  |  |\n| card_type    | 卡类型 | 枚举 | 是  | 参考附录：卡类型 |\n| treatment_no    | 就诊号 | 255 | 是  | 表示患者在本次就诊过程中的唯一标识  |\n| recipe_no    | 处方号/检查单/检验单 | 255 | 是  | 可能包含多个，多个按逗号分隔 |\n| fee | 总金额 | 金额 | 是  | 本次缴费总金额 |\n| sign    | 第三方交易签名 | 200 | 是  | 签名原文: card_no,card_type,treatment_no,recipe_no,fee,time_stamp 竖线分隔 |\n| cert    | 证书编号 | 200 | 是  | 参考附录：卡类型 |\n\n> **TIPS** 平台如何给患者展示待缴费项？\n> 平台根据treatment_no进行第一次聚合，根据group_id进行第二次聚合。完成后，给用户展示缴费列表。His可根据实际情况，以决定查询接口是否需要传group_id进行缴费。\n\n#### 响应结果\n```xml\n<response>\n  <ret_code>0</ret_code>\n  <ret_msg>成功</ret_msg>\n  <output>\n    <his_order_id>00028779822016110315043220161103162658</his_order_id>\n  </output>\n</response>\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| his_order_id    | his订单号 | 255 | 是  | his_order_id  |\n\n#### 接口实现要求\n由于网络交互中可能存在抖动和重传，His需要根据锁定接口中的`order_id`字段进行幂等判定标志。如果库中存在对应的`order_id`请直接返回之前生成的`his_order_id`进行幂等处理。切勿返回错误或新的单号。\n\n### 医保分解信息查询\n\n> **特别注意** 仅当患者持医保卡缴费时，会调用该接口。\n\n#### 调用方式\n```powershell\nURI: /ws/in_treatment/bill/medical/divide/query\nMethod: POST\n```\n\n#### 请求参数\n```xml\n<request>\n  <time_stamp>20161103163351</time_stamp>\n  <input>\n    <hos_code>H110321</hos_code>\n    <card_no>118969415001</card_no>\n    <card_type>3</card_type>\n    <order_id>200126854111</order_id>\n    <his_order_id>00028779822016110315043220161103162658</his_order_id>\n    <treatment_no>000201050320161103084138</treatment_no>\n    <recipe_no>d0000035526895</recipe_no>\n    <get_person_info><![CDATA[<!-- 参考医保文档 -->]]></get_person_info>\n  </input>\n</request>\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| hos_code    | 医院编码 | 20 | 是  |  |\n| card_no    | 卡号 | 20 | 是  | |\n| card_type    | 卡类型 | 枚举 | 是  | 参考附录：卡类型 |\n| order_id    | 平台订单号 | 20 | 是  |  |\n| his_order_id  | his订单号 | 255 | 是  | 锁定时His返回的订单号 |\n| treatment_no    | 就诊号 | 255 | 是  | 表示患者在本次就诊过程中的唯一标识  |\n| recipe_no    | 处方号/检查单/检验单 | 255 | 是  | 可能包含多个，多个按逗号分隔 |\n| get_person_info    | 社保`get_person_info`xml | XML | 是  | 社保串 |\n\n#### 返回结果\n```xml\n<response>\n  <ret_code>0</ret_code>\n  <ret_msg>成功</ret_msg>\n  <output>\n    <divide_xml><![CDATA[<!-- 分解参数-->]]></divide_xml>\n  </output>\n</response>\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| divide_xml | 医保分解参数 | XML | 否  | 参考医保文档 |\n\n**特别注意**平台如果检测到医保分解参数为空或者为`<![CDATA[]]>`的话，平台则将不进行医保分解。\n\n### 缴费完成通知\n用户支付成功后平台通过调用该接口进行缴费完成通知。\n\n#### 调用方式\n```powershell\nURI: /ws/in_treatment/bill/medical/paid\nMethod: POST\n```\n\n#### 请求参数\n```xml\n<request>\n  <time_stamp>20161104115305</time_stamp>\n  <input>\n    <hos_code>H110321</hos_code>\n    <card_no>98010003011511</card_no>\n    <card_type>2</card_type>\n    <order_id>200127073255</order_id>\n    <his_order_id>90001667662016110409205820161104115151</his_order_id>\n    <fee>2450.98</fee>\n    <trade_no>mpf_473128811211280004769</trade_no>\n    <treatment_no>900016676620161104092058</treatment_no>\n    <recipe_no>d0000035534466,d0000035534467</recipe_no>\n    <sign>MEx</sign>\n    <cert>1a100000000000192f53</cert>\n    <get_person_info><![CDATA[<!--参考医保文档-->]]></get_person_info>\n    <divide_out><![CDATA[<!--参考医保文档-->]]></divide_out>\n    <trade_out><![CDATA[<!--参考医保文档-->]]></trade_out>\n    <mechine_code>00014</mechine_code>\n  </input>\n</request>\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| hos_code    | 医院编码 | 20 | 是  |  |\n| card_no    | 卡号 | 20 | 是  | |\n| card_type    | 卡类型 | 枚举 | 是  | 参考附录：卡类型 |\n| order_id    | 平台订单号 | 20 | 是  |  |\n| his_order_id  | his订单号 | 255 | 是  | 锁定时His返回的订单号 |\n| fee | 总金额 | 金额 | 是||\n| trede_no  | 交易流水号 | 255 | 是  | 平台的交易流水号 |\n| treatment_no    | 就诊号 | 255 | 是  | 表示患者在本次就诊过程中的唯一标识  |\n| recipe_no    | 处方号/检查单/检验单 | 255 | 是  | 可能包含多个，多个按逗号分隔 |\n| sign  | 第三方交易签名 | 200 | 是  | 原文: card_no,card_type,trade_no,treatment_no,fee,recipe_no,time_stamp |\n| cert  | 证书编号 | 200 | 是  |  |\n| get_person_info    | 医保`get_person_info`xml | XML | 否  | 当为京医通卡时该字段为空 |\n| divide_out    | 医保分解结果| XML | 否  | 当为京医通卡时该字段为空 |\n| trade_out    | 门诊交易确认结果 | XML | 否  | 当为京医通卡时该字段为空 |\n\n#### 响应结果\n```xml\n<response>\n  <ret_code>0</ret_code>\n  <ret_msg>成功</ret_msg>\n  <output/>\n</response>\n```\n\n#### 接口实现要求\n由于网络交互中可能存在抖动和重传，His需要根据接口中的`order_id`字段进行幂等判定标志。如果库中存在对应的`order_id`已经支付成功，切忌返回错误信息，请返回支付成功，以便平台重试成功。\n\n>**特别注意**该接口实现幂等可以满足绝大部分的异常场景。按照现有的经验基本可以保证99.99%的正确率。\n\n### 获取缴费打印信息\n通过该接口获取打印信息，并为患者打印凭条。\n\n#### 调用方式\n```powershell\nURI: /ws/in_treatment/bill/print\nMethod: POST\n```\n\n#### 请求参数\n```xml\n<request>\n  <time_stamp>20161104121112</time_stamp>\n  <input>\n    <hos_code>H12938</hos_code>\n    <order_id>200127524483</order_id>\n    <his_order_id>90001414132016110408255320161104121010</his_order_id>\n    <card_no>98010002802867</card_no>\n    <card_type>1</card_type>\n  </input>\n</request>\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| hos_code    | 医院编码 | 20 | 是  |  |\n| order_id    | 平台订单号 | 12 | 是  | |\n| his_order_id    | his订单号 | 255 | 是 | |\n| card_no    | 卡号 | 20 | 是  | |\n| card_type    | 卡类型 | 枚举 | 是  | 参考附录：卡类型 |\n\n#### 响应结果\n```xml\n<response>\n  <ret_code>0</ret_code>\n  <ret_msg>成功</ret_msg>\n  <output>\n    <patient_id>0002935283</patient_id>\n    <medicine_windows/>\n    <birthday>2006-10-07</birthday>\n    <pay_type>2</pay_type>\n    <fee_item_list>\n      <fee_item>\n        <fee_item_code>l0000hcgz001</fee_item_code>\n        <fee_item_type>02</fee_item_type>\n        <fee_item_name>核磁共振</fee_item_name>\n        <fee_level>2</fee_level>\n        <unit_price>850</unit_price>\n        <count>1</count>\n        <fee>850</fee>\n        <specification>*10mg x16</specification>\n         <unit>盒</unit>\n         <usage>02</usage>\n         <dose>010101</dose>\n         <dosage>1</dosage>\n         <packaging>盒</packaging>\n         <days>24</days>\n         <medicare_place>二楼左侧</medicare_place>\n         <ext_info/>\n      </fee_item>\n    </fee_item_list>\n  </output>\n</response>\n```\n##### out_put\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| patient_id    | 患者id | 100 | 是  | 患者院内id |\n| medicine_windows    | 取药窗口 | 50 | 否  | 药品的取药窗口，打印在缴费清单上，可能跨多个窗口 |\n| birthday    | 生日 | 20 | 是  | yyyy-MM-dd |\n| pay_type    | his中的患者身份 | 枚举 | 是  | 枚举： 1-自费 2-医保 |\n| fee_item_list    | 收费项目 | 对象 | 是  | 参考下文:fee_item|\n\n##### fee_item\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| fee_item_code    | 收费项目代码 | 20 | 是  | |\n| fee_item_type    | 收费项目类别 | 枚举 | 是  | 枚举：1-诊察费 2-检查费 3-化验费 4-治疗费 5-手术费 6-卫生材料费 7-西药费 8-中草药费 9-中成药费 10-药事服务费 11-一般诊疗费 12-挂号费 99-其他 |\n| fee_item_name    | 院内项目名称 | 255 | 是  | 收费项目名称 |\n| fee_level    | 收费等级 | 枚举 | 是  | 枚举： 1-无自付 2-有自付 3-全自付|\n| unit_price    | 项目单价| 金额 | 是  | 最多两位小数 |\n| count  | 数量 | 10 | 浮点数  | 最多两位小数, 中药饮片需要精确到小数部分|\n| fee  | 收费项目合计金额  | 金额 | 是  |  |\n| specification  | 规格 | 40 | 否  | item_type为7、8、9时不能为空 |\n| unit  | 单位 | 20 | 否 | item_type为7、8、9时不能为空 |\n| usage  | 用法 | 2 | 否  | item_type为7、8、9时不能为空，引用自医保《用药频次BKC229》，参考文件：[用药频次目录](https://lev-inf.benmu-health.com/resource/file/download.do?resourceId=932ad14f192e7d95614ef19c0366999e) |\n| dose  | 剂型 | 枚举 | 否  | item_type为7、8、9时不能为空，引用自医保《剂型 AKA070》，参考文件：[剂型目录](https://lev-inf.benmu-health.com/resource/file/download.do?resourceId=6a0e9b95933eba2c0510f778a122a4d1) |\n| dosage  | 单次用量 | 20 | 否 | item_type为7、9时不能为空 |\n| packaging  | 包装单位 | 10 | 否  |  门诊零售包装单位，item_type为7、9时不能为空 |\n| days  | 用药天数 | 数字 | 否 | item_type为7、9时不能为空，其他可以为空  |\n| medicare_place  | 检查检验取药的地点| 50 | 否 | 检查检验取药的地点  |\n\n\n### 退费（平台提供接口）\n\n退费由于涉及到医保回滚、发票回收，及部分医院特殊功能，退费只能由窗口发起，调用线上平台。\n\n#### 调用方式\n```powershell\nURI: /ws/hos/${hos_code}/bill/medical/refund\nMethod: POST\n```\n\n#### 请求参数\n```xml\n<request> \n  <time_stamp>20161107150006</time_stamp>  \n  <input> \n    <ori_trade_no>20161024142907519957050</ori_trade_no>  \n    <order_id>20003100411<order_id>  \n    <refund_no>AM000000072482</refund_no>  \n    <treatment_no>000290900220161024135823</treatment_no>  \n    <recipe_no>U0000035399830,U0000035399830</recipe_no>  \n    <fee>655.74</fee>  \n    <medicare_has_refund>0</medicare_has_refund>  \n    <medicare_personal_has_refund>0</medicare_personal_has_refund>  \n    <sign>LLzht/U3c3w39MTWY=</sign>  \n    <cert>1b400000000000021653</cert> \n  </input> \n</request>\n\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| ori_trade_no    | 支付交易流水号 | 30 | 是  | 传入收费中的trade_no |\n| order_id    | 平台缴费单号 | 12 | 是  | 传收费中的order_id |\n| refund_no    | 退款流水号 | 30 | 是  | 由his生成。必须保证不能重复，该流水号将作为退费对账依据，平台将用该标志为幂等标志，多次使用同一流水号发起退款，将返回同样的结果 |\n| treatment_no    | 就诊号 | 255 | 是  | 表示患者在本次就诊过程中唯一标志，后续发生的检查、处方均与本字段关联 |\n| recipe_no    | 退款处方号/检查单号/检验单号 | C | 3000  | 多个元素以英文逗号分隔 |\n|fee | 本次应退总自费金额 | 金额| 是| 本次应退自费总金额，暂时不支持部分退款，必须传入总金额 |\n|medicare_has_refund|医保退费金额|金额|是|医保退费总金额，如果医保无需退费传入0|\n|medicare_personal_has_refund|医保个人账户退费金额|是|医保个人账户退费金额，如果没有则传入0|\n| sign  | 第三方交易签名 | 200 | 是  | 原文: ori_trade_no,refund_no,treatment_no,recipe_no,fee,time_stamp以竖线分隔 |\n| cert  | 证书编号 | 200 | 是  | 正式编号  |\n\n#### 响应结果\n```xml\n<response>\n  <ret_code>0</ret_code>\n  <ret_msg/>\n  <output>\n    <trade_no>54020167713741</trade_no>\n    <sign>MEYCIQC</sign>\n    <cert>1a100000000000192f53</cert>\n  </output>\n</response>\n```\n| 参数名称      | 描述 | 格式 |  必填   | 说明|\n| :-: | :-:| :-: | :-: | :-:|\n| trade_no    | 退款交易流水号 | 30 | 是  | 返回his入参中提供的退款流水号 |\n| 废弃字段 ~~sign~~ | ~~第三方交易签名~~ | ~~200~~ | ~~是~~ | ~~原文: trade_no,time_stamp 以竖线分隔~~  |\n| 废弃字段 ~~cert~~  | ~~证书编号~~ | ~~200~~ | ~~是~~  | ~~证书编号~~ |\n\n#### 接口调用要求\n1. 注意同一次退款，his向京医通线上平台提供的流水号必须保持一致，如果流水号变动将被认为是两次退款。京医通平台根据refund_no做接口幂等。在京医通线上平台未返回明确失败的情况下，由于网络抖动等情况，需要his执行重试操作。\n2. 该接口在3次调用（5秒钟间隔）超时的情况下（注意：无响应是指调用超时，不是异常返回），建议his先完成医保退费分解，并将本系统的处方标记为退款异常，告知患者退款会稍后到账，并记录下本次调用信息，之后以5分钟间隔重试调用，**直到成功为止**。"
    }
  ]
}