{
  "title": "Untitled Note",
  "cells": [
    {
      "type": "text",
      "data": "<div>## 多渠道取号</div><div>@(本木医疗)[接口, 多渠道取号，新增异常处理机制]</div><div><br></div><div>多渠道取号是指从其他渠道的挂号单可以通过京医通自助机取号。实现多渠道接口包含了如下三个部分：</div><div>- 多渠道主体接口实现</div><div>- 之前接口的改造</div><div>需要适配一些字段，另外His内部针对多渠道的订单也需要改造。</div><div>- 异常处理机制升级</div><div>按照之前的异常处理机制无法满足多渠道的业务场景。</div><div>- 支持AB卡功能</div><div>为了使多渠道功能更加完善，开发者需要针对取号增加对AB卡功能的支持。</div><div><br></div><div>### 业务说明</div><div>当患者通过任意形式或渠道预约挂号，挂号信息到His系统中之后。平台系统即可实时同步，后续该挂号单的所有生命周期的变化过程都会被同步过来。</div><div><br></div><div>就诊当日患者持社保卡或京医通卡，插卡查询自助机。会出现如下几种情况：</div><div>**默认情况**</div><div>预约单卡号与患者卡号匹配，身份信息匹配，患者即可取卡后进行后续操作</div><div>**支持AB卡的情况下**</div><div>预约单上无卡号，但是身份信息匹配，患者也可以使用社保卡或京医通卡进行取号</div><div>预约单上有京医通卡号，但是身份信息匹配，患者可以通过自己的任意京医通卡进行取号进行取号。</div><div><br></div><div>### 后续交互说明</div><div><br></div><div>默认平台同步到的订单，平台认为是已经锁号成功的状态。后续正向流程如下操作</div><div>- 查询是否可以取号</div><div>- 支付通知成功</div><div>- 取号</div><div>- 获取打印信息</div><div><br></div><div>总得来说后续流程与线上单完全保持一致。**只是针对多渠道订单，平台系统不会再任何节点发起自动解锁的逻辑**</div><div><br></div><div>### 号源挂号单接口明细</div><div><br></div><div>平台定时增量进行同步，开发者在挂号表中需设置update_time字段，并为其新增`更新触发器`每次更新该记录时自动更新时间戳。并且在该字段上设置索引，加速查询。</div><div><br></div><div>&gt; **特别注意：更新时间戳，不是指挂号单（或预约单）生成的时间点，也不是倒入his的时间点，更不是就诊时间点。而是这条记录（数据库的概念）中常常使用的`update_time`字段。理解为该记录上次更新时间即可。**</div><div><br></div><div>#### 调用方式</div><div>```powershell</div><div>URI: /ws/reg/sync</div><div>Method: POST</div><div>```</div><div><br></div><div>#### 请求参数</div><div>```xml</div><div>&lt;request&gt;</div><div>&nbsp; &lt;time_stamp&gt;20161009091151&lt;/time_stamp&gt;</div><div>&nbsp; &lt;input&gt;</div><div>&nbsp; &nbsp; &lt;hos_code&gt;H114801&lt;/hos_code&gt;</div><div>&nbsp; &nbsp; &lt;last_update_time_from&gt;20151111100000&lt;/last_update_time_from&gt;</div><div>&nbsp; &nbsp; &lt;last_update_time_to&gt;20151111110000&lt;/last_update_time_to&gt;</div><div>&nbsp; &lt;/input&gt;</div><div>&lt;/request&gt;</div><div>```</div><div>| 参数名称 &nbsp; &nbsp; &nbsp;| 描述 | 格式 | &nbsp;必填 &nbsp; | 说明|</div><div>| :-: | :-:| :-: | :-: | :-:|</div><div>| hos_code &nbsp; &nbsp;| 医院编码 | 10 | 是 &nbsp;| &nbsp;|</div><div>| last_update_time_from &nbsp; &nbsp;| 更新时间戳 | 14 | 是 &nbsp;| yyyyMMddHHmmss 参考上述特别注意 |</div><div>| last_update_time_to &nbsp; &nbsp;| 更新时间戳 | 14 | 否 | yyyyMMddHHmmss 参考上述特别注意 |</div><div><br></div><div>&gt; **Q&amp;A**</div><div>&gt; - **为什么要使用增量同步的方式？**</div><div>&gt; 使用增量同步主要是为了降低His负载压力，只同步`有变化`的挂号单，将患者信息，患者建卡，患者与院方绑定，患者电话医院取消预约等多种情况结合起来处理。</div><div>&gt;&nbsp;</div><div>&gt; - **为什么不使用实时查询接口，在患者取号时才进行同步？**</div><div>&gt; 实时查询接口有以下几个限制例如：业务场景无法完全处理，预约信息取消、停诊等场景无法处理。无法实现微信通知患者预约成功，否则需要另加通知接口。对应的微信和自助机的挂号信息查询接口的速度受制于各家His的实际情况。显然不能由于A医院接口问题而影响B医院的患者查询挂号单。</div><div>&gt;</div><div>&gt; - **如果我的数据库性能，没有任何压力，是否可以全量同步？**</div><div>&gt; 由于涉及多种挂号单信息的变化，如果不进行增量同步，平台将无法得知取消停诊等相关信息。举个例子，如果使用全量同步，比如His每次都返回当日的挂号单数据，如果用户8号预约了一个10号就诊的订单，9号医生停诊了，这个订单平台是要到10号才能同步过来，所以平台在这种情况下无法通知患者停诊信息。对应的一些其他的业务场景也是如此。如果不采用增量同步接口，平台将需要提供大量的辅助接口完成多渠道的完整功能。</div><div>&gt;</div><div>&gt; - **为什么不提供通知接口，采用通知-拉取的模式**</div><div>&gt; 不同的医院的开发模式和开发团队水平并不一致。为了简单起见，避免短板，取消了通知接口的设计。平台根据增量接口，变换策略地进行拉取，以保证数据一致。</div><div>&gt;</div><div>&gt;- **我的系统中存在多个子系统，很难提供最后更新时间**</div><div>&gt; 那么请开发者在以下几个业务节点中更新记录时间。具体节点如下：创建时间点，支付时间点，取消时间点，取号时间点。</div><div><br></div><div>如果His系统中表信息过大，加索引耗费很大，建议新建一个表专门用于同步。建议开发者在这方面更多地考虑以适应该接口。</div><div><br></div><div>#### 响应结果</div><div>`reg_list`节点下可以包含多个`reg`节点。</div><div>```xml</div><div>&lt;response&gt;</div><div>&nbsp; &lt;ret_code&gt;0&lt;/ret_code&gt;</div><div>&nbsp; &lt;ret_msg&gt;成功&lt;/ret_msg&gt;</div><div>&nbsp; &lt;output&gt;</div><div>&nbsp; &nbsp; &lt;hos_code&gt;h110321&lt;/hos_code&gt;</div><div>&nbsp; &nbsp; &lt;reg_list&gt;</div><div>&nbsp; &nbsp; &nbsp; &lt;reg&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;his_reg_no&gt;623150&lt;/his_reg_no&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;card_no&gt;98000002405695&lt;/card_no&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;card_type&gt;1&lt;/card_type&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;dept_code1&gt;13470528&lt;/dept_code1&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;dept_code2&gt;0001&lt;/dept_code2&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;usertype&gt;普通&lt;/usertype&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;patient_name&gt;何建云&lt;/patient_name&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;id_card&gt;142324197401213114&lt;/id_card&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;id_card_type&gt;1&lt;/id_card_type&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;sex&gt;1&lt;/sex&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;birthday&gt;1974-01-21&lt;/birthday&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;purpose&gt;2&lt;/purpose&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;area_code&gt;110101&lt;/area_code&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;doctor_code&gt;040603&lt;/doctor_code&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;doctor_name&gt;张东教授团队&lt;/doctor_name&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;title_type&gt;3&lt;/title_type&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;reg_date&gt;20161012&lt;/reg_date&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;reg_half&gt;2&lt;/reg_half&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;time&gt;201610121300-201610121300&lt;/time&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;fee&gt;60&lt;/fee&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;user_amount/&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;medicare_amount/&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;medicare_person_fee/&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;remark/&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;status&gt;2&lt;/status&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;place/&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;source&gt;2&lt;/source&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;pay_source&gt;1&lt;/pay_source&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;update_time&gt;20161010150617&lt;/update_time&gt;</div><div>&nbsp; &nbsp; &nbsp; &nbsp; &lt;phone&gt;1851000000&lt;/phone&gt;</div><div>&nbsp; &nbsp; &nbsp; &lt;/reg&gt;</div><div>&nbsp; &nbsp; &lt;/reg_list&gt;</div><div>&nbsp; &lt;/output&gt;</div><div>&lt;/response&gt;</div><div>```</div><div>&gt; **特别说明**</div><div>&gt; **自助机上取号的渠道目前有：窗口预约，114，全市统一平台，诊间预约，出院预约，社区转诊预约这些可以取号。传其他渠道，编号99这种是不能取号的。如果有例如院内微信这种新渠道，可以与平台协商新增渠道编号，his用这个新编号来传，这样就可以取号了。**</div><div><br></div><div>| 参数名称 &nbsp; &nbsp; &nbsp;| 描述 | 格式 | &nbsp;必填 &nbsp; | 说明|</div><div>| :-: | :-:| :-: | :-: | :-:|</div><div>| hos_code &nbsp; &nbsp;| 医院编码 | 10 | 是 &nbsp;| &nbsp;|</div><div>| his_reg_no &nbsp; &nbsp;| His生成的挂号单号 | 255 | 是 &nbsp;| |</div><div>| card_no &nbsp; &nbsp;| 卡号 | 20 | 否 &nbsp;| &nbsp;|</div><div>| card_type &nbsp;| 卡类型 | 枚举 | 否 | &nbsp;|</div><div>| dept_code1 &nbsp;| 一级科室 | 20 | 是 | &nbsp; |</div><div>| dept_code2 &nbsp;| 二级科室 | 20 | 是 | &nbsp; |</div><div>| usertype &nbsp;| 用户类型 | 20 | 否 | &nbsp;自费，普通医保，工伤 |</div><div>| patient_name &nbsp;| 患者姓名 | 10 | 是 | &nbsp;患者联系电话 |</div><div>| phone &nbsp;| 患者联系电话 | 11 | 是 | 患者联系电话 &nbsp;|</div><div>| id_card &nbsp;| 患者证件号码 | 30 | 否 | |</div><div>| id_card_type &nbsp;| 患者证件号码 | 枚举 | 否 | 参考附录：证件类型 |</div><div>| sex &nbsp;| 性别 | 枚举 | 否 | 参考附录：患者性别 |</div><div>| birthday &nbsp;| 患者生日 | 日期 | &nbsp;否 | 格式:yyyy-MM-dd |</div><div>| purpose &nbsp;| 是否专程来京就医 | 枚举 | 否 | 1-是 2-否 |</div><div>| area_code &nbsp;| 区县/行政区域 | 20 | 否 | 参考附录：行政区域 |</div><div>| doctor_code &nbsp;| 医生编码 | 20 | 是 | 特殊情况下，可传固定值 |</div><div>| doctor_name &nbsp;| 医生名字 | 20 | 是 | &nbsp;|</div><div>| title_type &nbsp;| 号源类型 | 枚举 | 是 | 参考附录：号源类型 |</div><div>| reg_date &nbsp;| 就诊日期 | 日期 | 是 | 格式:yyyyMMdd |</div><div>| reg_half &nbsp;| 就诊单元 | 枚举 | 是 | 参考附录：就诊单元 |</div><div>| time &nbsp;| 就诊时间段 | 30 | 是 | 例如：`yyyyMMddHHmm-yyyyMMddHHmm`|</div><div>| fee &nbsp;| 挂号总费用 | 金额 | 是 | &nbsp;|</div><div>| user_amount &nbsp;| 用户自费部分金额 | 金额 | 是 | 未取号时传0|</div><div>| medicare_amount &nbsp;| 医保基金支付部分金额 | 金额 | 是 | 未取号时传0 |</div><div>| medicare_person_fee &nbsp;| 医保个人账户支付金额 | 金额 | 是 | 未取号时传0|</div><div>| status | &nbsp;挂号单状态 | 枚举| 是 | 1 - 初始状态， 2- 已支付， 3 - 已取号， 4 - 已取消（包含已退号） |</div><div>| place &nbsp;| 就诊地点 | 200 | 否 | |</div><div>| source &nbsp;| 来源 | 枚举 | 是 | 1-窗口 2-京医通线上平台 3-114 4-全市统一平台 5-医生诊间预约 6-出院预约 7-社区转诊预约 8-支付宝&nbsp;<span style=\"color: rgb(104, 151, 187); font-family: Monaco; font-size: 10.5pt; background-color: rgb(43, 43, 43);\">9-</span><span style=\"color: rgb(106, 135, 89); font-family: Monaco; font-size: 10.5pt; background-color: rgb(43, 43, 43);\">官网预约&nbsp;</span><span style=\"color: rgb(104, 151, 187); font-family: Monaco; font-size: 10.5pt; background-color: rgb(43, 43, 43);\">10-</span><span style=\"color: rgb(106, 135, 89); font-family: Monaco; font-size: 10.5pt; background-color: rgb(43, 43, 43);\">院内电话预约&nbsp;</span><span style=\"color: rgb(221, 221, 221); background-color: rgb(43, 43, 43);\">99-其他|</span></div><div>| pay_source| 支付渠道 | 枚举 | 是| 0. 初始状态(未支付)， 1. 京医通线上平台 2. 医院窗口支付 99. 其他 |</div><div>| update_time &nbsp;| 最后更新时间戳 | 14 | 是 | yyyyMMddHHmmss, 用于计算时间戳 |</div><div>| remark &nbsp;| 备注信息 | 200 | 否 | <span class=\"Apple-tab-span\" style=\"white-space:pre\">\t</span>显示在号源旁边的备注信息，与号源查询接口保持一致。 |</div><div><br></div><div>&gt; **特别注意**</div><div>&gt; 当没有预约信息时，请返回`ret_code=0`，`reg_list`为空的响应形式。</div><div><br></div><div>&gt; **TIPS** 关于金额&nbsp;</div><div>&gt; 未取号时，`fee`为挂号总额，`user_amount`，`medicare_amount`，`medicare_person_fee` 为0</div><div>&gt; 取号后的订单，`user_amount`，`medicare_amount`，`medicare_person_fee` 三个参数的和必须等于fee的值</div><div><br></div><div>注意到接口说明中存在不少字段可以为空。</div><div><br></div><div>由于患者在不同的途径下对不同的医院进行预约，所需要提供的信息各不相同的情况，很多医院都存在预约信息不全的状况。按照医院的现有情况来说，有的医院可能会自动匹配患者信息，有的医院不会自动匹配患者信息，而是等到就诊日患者持卡或者建卡时人工进行关联。</div><div><br></div><div>为了兼容这种状况，平台支持先预约后补全的模式。结合实际考察多家医院处理模式，对部分字段做了非必填的要求。</div><div><br></div><div>&gt;患者通过电话114预约，只需提供身份证号码，姓名以及电话号码即可预约成功。</div><div>&gt;- 在A医院中，患者在就诊日当天到窗口进行处理。窗口根据患者提供的身份证信息，手动关联程序中的预约单与患者关系（也可能涉及到建档、建卡等操作）。</div><div>&gt;- 在B医院中，可能患者之前在His中已经预约过，并在院内已有档案。此时His自动关联患者卡号。</div><div>&gt;- 在C医院中，患者未在His中预约过，His自动生成虚拟账户进行关联。</div><div><br></div><div>但是针对平台来说，并不存在档案的要求。患者只要持卡在自助机操作（卡已在院内绑定），平台通过认证卡信息（114平台需要验证身份信息），匹配对应预约单即可。</div><div><br></div><div>所以，上述为空字段，例如：卡号、卡类型、证件号、证件类型，在初始同步的时候为空。但是在后续，如果患者在线下，或者His程序自动，或者窗口人员操作后，仍会继续同步过来。此时，患者操作自助机，平台根据卡号、证件号才可以查询到挂号单。</div><div><br></div><div>&gt; **TIPS**</div><div>&gt; 针对有的His，部分未绑定卡关系的患者，或者不具备京医通卡的患者，多渠道取号功能仍然相对麻烦。除了His自身内部可以利用程序自动关联以外。建议也实施下面两个功能：</div><div>&gt; - AB取卡。</div><div>&gt; - 自助绑定。</div><div>&gt; 其具体功能参考对应的文档。</div><div><br></div><div>### 取消</div><div><br></div><div>#### 患者在his取消预约</div><div>考虑如下场景：患者通过院方电话或其他渠道，在his系统中取消了该单。平台通过同步接口增量获取到该单状态变更为`status=4`，此时即可自动在平台取消。所以His只用按照增量接口的实现说明实现，即可实现his取消预约的功能。</div><div><br></div><div>#### 患者在平台取消预约</div><div>平台通过调用his的取消锁号接口，进行预约取消。His需支持该类订单的取消锁号功能。</div><div><br></div><div>#### 其他业务场景的自动取消</div><div>针对多渠道订单，平台将屏蔽**所有的自动取消**功能。例如，</div><div>- 超时未支付自动取消锁号</div><div>- 停诊自动退号（取消锁号）</div><div>- 等等</div><div><br></div><div>### 支付</div><div>患者只能在就诊当日在自助机进行支付。不存在任何提前支付的场景。患者持卡在自助机验证身份通过后。平台将按普通当日挂号的模式进行接口调用，其顺序如下：</div><div>- 获取医保分解信息</div><div>- 支付成功通知</div><div>- 取号</div><div>- 打印</div><div><br></div><div>&gt; **特别注意**</div><div>&gt; - 针对多渠道订单，His在支付成功通知接口才能获取平台的`reg_no`, 开发者需注意更新本地的`reg_no`</div><div>&gt; - 针对多渠道订单，当患者支付取号后（his以收到支付成功通知为准），后续的操作his均需按照平台普通订单进行。</div><div><br></div><div>### 停诊</div><div><br></div><div>如果His系统中，**订单已经停诊，请勿同步给平台。**，如果同步给平台后，平台能够收到停诊通知的情况下，均会处理停诊订单，与原逻辑保持一致平台统一做后续处理</div><div><br></div><div>### 爽约</div><div>多渠道订单不计入爽约</div><div><br></div><div>### 清算</div><div>多渠道订单需进行资金清算。开发者按照如下标准改造对账接口：“当支付渠道（`pay_source`）为线上平台时，则需要进行清算”。其他细节请根据自身业务情况进行开发</div><div><br></div><div>### 线下取号、线下退号</div><div>多渠道订单可以进行线下取号、线下退号操作。开发者按照如下标准改造对账接口：“当支付渠道（`pay_source`）为线上平台时，退号、取号时需要与之前逻辑保持一致。</div><div><br></div><div>### 异常处理机制</div><div>多渠道订单由于处理流程特殊，在整体的异常处理机制上必须升级，如果开发者对多渠道进行开发。那么需要参考`异常处理机制`一节中所有内容并加以实现。并且建议熟读挂号部分的其他内容。</div><div><br></div><div>在多渠道验收时，**将针对整体挂号部分进行验收。特别注意，相关接口需要幂等处理**</div>"
    }
  ]
}